#
# Copyright 2017 Alec Missine (support@minetats.com) 
#                and the Arbitrage Logistics International (ALI) project
#
# The ALI Project licenses this file to you under the Apache License, version 2.0
# (the "License"); you may not use this file except in compliance with the License.
# You may obtain a copy of the License at:
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software distributed
# under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
# CONDITIONS OF ANY KIND, either express or implied. See the License for the
# specific language governing permissions and limitations under the License.
#
# This makefile sets up your ctlsvc account, starts the service and configures SSH.
#
# See also:
#   https://docs.google.com/document/d/1JPzTa7IXEQL0NZLoO5leCNj40e7yy1dFNMiqTtBNH2o/
#   https://www.gnu.org/software/make/manual/html_node/index.html

# Check if 'make' is run from your home directory.
ifneq ($(PWD),$(HOME))
  $(error Please try 'sudo -E make' from $(HOME) directory)
endif

# Run all shell commands with bash.
SHELL := bash

.PHONY: setup

setup: ctlsvc ssh
	@rm $^

ctlsvc: ctlsvc_distro/ctlsvc.sh
	@if [ `uname` = 'Linux' ]; then svc="ctlsvc_$(SUDO_USER)"; [ -x /etc/init.d/$$svc ] || { \
		cp project/lnet/setup/ctlsvc /etc/init.d/$$svc; \
	  cd /etc/init.d; sed -i "s/@CTLSVC_ACCOUNT@/$(SUDO_USER)/" $$svc; \
		update-rc.d $$svc defaults; service $$svc start; }; service $$svc status; \
	 else \
	  ctlsvc_distro/ctlsvc.sh; \
	 fi
	@echo $@ > $@

ctlsvc_distro/ctlsvc.sh: project/lnet/bin/ctlsvc.sh
	@mkdir ctlsvc_distro 2>/dev/null; cp project/lnet/bin/ctlsvc.sh ctlsvc_distro
	@cd ctlsvc_distro; bak=''; [ `uname` = "Darwin" ] && bak="''";\
		sed -i $$bak "s/@CTLSVC_ACCOUNT@/$(SUDO_USER)/" ctlsvc.sh

ssh:
	@echo $@ > $@